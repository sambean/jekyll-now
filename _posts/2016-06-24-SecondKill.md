---
layout: post
tags: [jekyll, github, git, markdown]
title: 秒杀系统设计
---
   秒杀场景在电商中是经常出现的,也是非常考验电商系统的系统稳定性的。

  一个电商系统大致由以下系统的组成：
  <ul>
    <li>订单系统</li>
    <li>商品系统(广义的商品系统,可以细分为 商品详情系统 库存系统 等更小粒度的)</li>
    <li>用户系统</li>
    <li>优惠活动系统(广义的优惠活动系统,可以细分为 优惠券系统,积分系统,活动系统等)</li>
    <li>搜索系统</li>
    <li>供应链系统(如果是自建物流的话)</li>
  </ul>


   在秒杀的时候,搜索系统,用户系统不会承受太大的压力,我们忽略不计。

   供应链系统处于后端,应该不会有任何一个电商系统在用户下单的时候同步调用供应链系统服务，应该也不会有太大问题。

   秒杀的瓶颈主要会集中在 订单系统 商品系统 用户系统以及优惠活动系统中。

   为什么秒杀会对优惠活动系统造成压力呢?

   因为用户可能会使用优惠券/积分抵扣支付金额

   一个最简单的秒杀的请求 订单系统会调用商品系统查询并且锁定库存,如果用户使用了积分/优惠券还要调用积分/优惠券系统去扣减积分/核销优惠券,如果这2步都成功，则秒杀成功

整个过程里涉及2次RPC调用，1次商品系统的RPC调用，1次优惠券活动系统的RPC调用,所以想要提高秒杀的响应速度,就要从减少RPC调用入手

   1. 秒杀商品从业务上就限制用户使用积分/优惠券,本身秒杀商品的性价比已经是很高了，禁止用户使用优惠券,积分相信用户也能理解.
   2. 如果确实需要允许用户使用积分/优惠券抵扣秒杀商品,可以考虑把用户的 积分/优惠券 放到redis里,优惠券活动系统提供二方包(jar包)给订单系统调用,
   二方包里操作redis同时通过消息中间件发送消息给优惠券系统异步操作数据库
   当然引入了Redis和消息中间件肯定会带来其他的问题,例如 数据的一致性,如果消息中间件挂了怎么办等等问题。
   3.对商品系统的RPC调用也可以通过将商品的库存放到redis里,然后商品系统提供二方包（jar包)给订单系统调用,同样通过消息异步通知商品系统操作数据库,同样也会
   遇到数据一致性的问题.
   4. 尽量少用mysql行锁,可以考虑用redis /zookeeper 实现分布式锁。 
   
